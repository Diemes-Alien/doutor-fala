<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fala Doutor - Médicos e Pacientes</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <h1>Cadastrar Médico</h1>
  <input id="nome" placeholder="Nome" /><br />
  <input id="cpf" placeholder="CPF" /><br />
  <input id="crm" placeholder="CRM" /><br />
  <input id="data_nascimento" type="date" placeholder="Data de Nascimento" /><br />
  <button onclick="cadastrarMedico()">Cadastrar</button>

  <h2>Lista de Médicos</h2>
  <button onclick="listarMedicos()">Atualizar Lista</button>
  <ul id="lista-medicos"></ul>

  <hr />

  <h1>Cadastrar Paciente</h1>
  <input id="nome_paciente" placeholder="Nome" /><br />
  <input id="cpf_paciente" placeholder="CPF" /><br />
  <select id="plano_paciente">
    <option value="">Selecione o plano</option>
    <option value="plano_1">Plano 1</option>
    <option value="plano_2">Plano 2</option>
    <option value="plano_3">Plano 3</option>
  </select><br />
  <input id="data_nascimento_paciente" type="date" placeholder="Data de Nascimento" /><br />
  <button onclick="cadastrarPaciente()">Cadastrar Paciente</button>

  <h2>Lista de Pacientes</h2>
  <button onclick="listarPacientes()">Atualizar Lista</button>
  <ul id="lista-pacientes"></ul>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/+esm'

    const supabaseUrl = 'https://zharsswajgrdlalnshmy.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoYXJzc3dhamdyZGxhbG5zaG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMTUwNDgsImV4cCI6MjA2NTU5MTA0OH0.7U6Wsoo6B4dhsIuFwCSbVQIf4ndhpAd9LdYaZO-Ku7w'

    const supabase = createClient(supabaseUrl, supabaseKey)

    // MÉDICOS

    window.cadastrarMedico = async function () {
      const nome = document.getElementById('nome').value.trim()
      const cpf = document.getElementById('cpf').value.trim()
      const crm = document.getElementById('crm').value.trim()
      const data_nascimento = document.getElementById('data_nascimento').value

      if (!nome || !cpf || !crm || !data_nascimento) {
        alert('Por favor, preencha todos os campos do médico.')
        return
      }

      const { error } = await supabase
        .from('medicos')
        .insert([{ nome, cpf, crm, data_nascimento }])

      if (error) {
        console.error('Erro ao cadastrar:', error)
        alert('Erro ao cadastrar: ' + error.message)
      } else {
        alert('Médico cadastrado com sucesso!')
        limparCamposMedico()
        listarMedicos()
      }
    }

    window.listarMedicos = async function () {
      const { data, error } = await supabase
        .from('medicos')
        .select('*')

      if (error) {
        console.error('Erro ao listar médicos:', error)
        return
      }

      const lista = document.getElementById('lista-medicos')
      lista.innerHTML = ''

      data.forEach(medico => {
        lista.innerHTML += `
          <li>
            <strong>${medico.nome}</strong> | CRM: ${medico.crm} | CPF: ${medico.cpf}
            <button onclick="editarMedico('${medico.id}')">Editar</button>
            <button onclick="excluirMedico('${medico.id}')">Excluir</button>
          </li>
        `
      })
    }

    window.excluirMedico = async function (id) {
      const confirmar = confirm('Tem certeza que deseja excluir este médico?')
      if (!confirmar) return

      const { error } = await supabase
        .from('medicos')
        .delete()
        .eq('id', id)

      if (error) {
        console.error('Erro ao excluir:', error)
        alert('Erro ao excluir: ' + error.message)
      } else {
        alert('Médico excluído com sucesso!')
        listarMedicos()
      }
    }

    window.editarMedico = async function (id) {
      // Buscar dados atuais
      const { data, error } = await supabase
        .from('medicos')
        .select('*')
        .eq('id', id)
        .single()

      if (error) {
        alert('Erro ao buscar dados do médico: ' + error.message)
        return
      }

      const nome = prompt('Nome:', data.nome)
      if (nome === null) return
      const cpf = prompt('CPF:', data.cpf)
      if (cpf === null) return
      const crm = prompt('CRM:', data.crm)
      if (crm === null) return
      const data_nascimento = prompt('Data de Nascimento (YYYY-MM-DD):', data.data_nascimento)
      if (data_nascimento === null) return

      if (!nome.trim() || !cpf.trim() || !crm.trim() || !data_nascimento.trim()) {
        alert('Todos os campos são obrigatórios.')
        return
      }

      const { error: updateError } = await supabase
        .from('medicos')
        .update({ nome: nome.trim(), cpf: cpf.trim(), crm: crm.trim(), data_nascimento: data_nascimento.trim() })
        .eq('id', id)

      if (updateError) {
        alert('Erro ao atualizar médico: ' + updateError.message)
      } else {
        alert('Médico atualizado com sucesso!')
        listarMedicos()
      }
    }

    function limparCamposMedico() {
      document.getElementById('nome').value = ''
      document.getElementById('cpf').value = ''
      document.getElementById('crm').value = ''
      document.getElementById('data_nascimento').value = ''
    }

    // PACIENTES

    window.cadastrarPaciente = async function () {
      const nome = document.getElementById('nome_paciente').value.trim()
      const cpf = document.getElementById('cpf_paciente').value.trim()
      const plano = document.getElementById('plano_paciente').value
      const data_nascimento = document.getElementById('data_nascimento_paciente').value

      if (!nome || !cpf || !plano || !data_nascimento) {
        alert('Por favor, preencha todos os campos do paciente.')
        return
      }

      const { error } = await supabase
        .from('pacientes')
        .insert([{ nome, cpf, plano, data_nascimento }])

      if (error) {
        console.error('Erro ao cadastrar paciente:', error)
        alert('Erro ao cadastrar paciente: ' + error.message)
      } else {
        alert('Paciente cadastrado com sucesso!')
        limparCamposPaciente()
        listarPacientes()
      }
    }

    window.listarPacientes = async function () {
      const { data, error } = await supabase
        .from('pacientes')
        .select('*')

      if (error) {
        console.error('Erro ao listar pacientes:', error)
        return
      }

      const lista = document.getElementById('lista-pacientes')
      lista.innerHTML = ''

      data.forEach(paciente => {
        lista.innerHTML += `
          <li>
            <strong>${paciente.nome}</strong> | CPF: ${paciente.cpf} | Plano: ${paciente.plano}
            <button onclick="editarPaciente('${paciente.id}')">Editar</button>
            <button onclick="excluirPaciente('${paciente.id}')">Excluir</button>
          </li>
        `
      })
    }

    window.excluirPaciente = async function (id) {
      const confirmar = confirm('Tem certeza que deseja excluir este paciente?')
      if (!confirmar) return

      const { error } = await supabase
        .from('pacientes')
        .delete()
        .eq('id', id)

      if (error) {
        console.error('Erro ao excluir paciente:', error)
        alert('Erro ao excluir paciente: ' + error.message)
      } else {
        alert('Paciente excluído com sucesso!')
        listarPacientes()
      }
    }

    window.editarPaciente = async function (id) {
      // Buscar dados atuais
      const { data, error } = await supabase
        .from('pacientes')
        .select('*')
        .eq('id', id)
        .single()

      if (error) {
        alert('Erro ao buscar dados do paciente: ' + error.message)
        return
      }

      const nome = prompt('Nome:', data.nome)
      if (nome === null) return
      const cpf = prompt('CPF:', data.cpf)
      if (cpf === null) return

      // Para plano, pedimos que escolha um dos valores válidos:
      const plano = prompt('Plano (plano_1, plano_2, plano_3):', data.plano)
      if (plano === null) return
      if (!['plano_1', 'plano_2', 'plano_3'].includes(plano.trim())) {
        alert('Plano inválido. Use plano_1, plano_2 ou plano_3.')
        return
      }

      const data_nascimento = prompt('Data de Nascimento (YYYY-MM-DD):', data.data_nascimento)
      if (data_nascimento === null) return

      if (!nome.trim() || !cpf.trim() || !plano.trim() || !data_nascimento.trim()) {
        alert('Todos os campos são obrigatórios.')
        return
      }

      const { error: updateError } = await supabase
        .from('pacientes')
        .update({ nome: nome.trim(), cpf: cpf.trim(), plano: plano.trim(), data_nascimento: data_nascimento.trim() })
        .eq('id', id)

      if (updateError) {
        alert('Erro ao atualizar paciente: ' + updateError.message)
      } else {
        alert('Paciente atualizado com sucesso!')
        listarPacientes()
      }
    }

    function limparCamposPaciente() {
      document.getElementById('nome_paciente').value = ''
      document.getElementById('cpf_paciente').value = ''
      document.getElementById('plano_paciente').value = ''
      document.getElementById('data_nascimento_paciente').value = ''
    }

    // Listar dados assim que a página carregar
    listarMedicos()
    listarPacientes()
  </script>
</body>
</html>
